{% extends "base.html" %}
{% block content %}
    <div class="row align-items-center" style="height: 15vh;">
        <h1>NORMAL OR RANKED MATCHMAKING</h1>
    </div>
    <h5 class="mt-4 mb-4">FIRST PHASE</h5>
    <div class="row"> <!-- Row contenitore input group prima fase -->
        <div class="col-lg-5 col-sm-12 mb-3">
            <div class="input-group mb-3">
                <div class="input-group-text input-group-text-nr">Your team pick nr. 1</div>
                <select class="form-select select2" id="alliedHero1" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <div class="input-group-text input-group-text-nr">Your team pick nr. 2</div>
                <select class="form-select select2" id="alliedHero2" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-5 col-sm-12 mb-3">
            <div class="input-group mb-3">
                <div class="input-group-text input-group-text-nr">Enemy team pick nr. 1</div>
                <select class="form-select select2" id="enemyHero1" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <div class="input-group-text input-group-text-nr">Enemy team pick nr. 2</div>
                <select class="form-select select2" id="enemyHero2" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-2 col-sm-12 mb-3">
            <button id="suggestButton34nr" type="button" class="btn btn-success">SUGGEST 3° AND 4° PICKS</button>
        </div>
    </div>
    <div class="row mt-4 mb-4"> <!-- Row contenitore primo pulsante suggerimenti -->
        <div class="col-12">
            <div id="picks34TextBox" class="border p-3" style="font-family: 'Courier New', monospace; height: auto;">
                <p>Your team should choose two of those heroes for the 3^ and 4^ pick:</p>
                <p id="generatedText34nr"><span id="cursor34nr" class="cursor">|</span></p>
            </div>
        </div>
    </div>
    <h5 class="mt-5 mb-4">SECOND PHASE</h5>
    <div class="row"> <!-- Row contenitore seconda fase -->
        <div class="col-lg-5 col-sm-12 mb-3">
            <div class="input-group mb-3">
                <div class="input-group-text input-group-text-nr">Your team pick nr. 3</div>
                <select class="form-select select2" id="alliedHero3" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <div class="input-group-text input-group-text-nr">Your team pick nr. 4</div>
                <select class="form-select select2" id="alliedHero4" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-5 col-sm-12 mb-3">
            <div class="input-group mb-3">
                <div class="input-group-text input-group-text-nr">Enemy team pick nr. 3</div>
                <select class="form-select select2" id="enemyHero3" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <div class="input-group-text input-group-text-nr">Enemy team pick nr. 4</div>
                <select class="form-select select2" id="enemyHero4" data-placeholder="Select one hero">
                    <option></option>
                    {% for hero in heroes %}
                        <option value="{{ hero }}">{{ hero }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-lg-2 col-sm-12 mb-3">
            <button id="suggestButton5" type="button" class="btn btn-success">SUGGEST 5° PICK</button>
        </div>
    </div>
    <div class="row mt-4 mb-5 "> <!-- Row contenitore secondo pulsante suggerimenti -->
        <div class="col-12">
            <div id="picks5TextBox" class="border p-3" style="font-family: 'Courier New', monospace; height: auto;">
                <p>Your team should choose one of those heroes for the 5^ and last pick:</p>
                <p id="generatedText5"><span id="cursor5" class="cursor">|</span></p>
            </div>
        </div>
    </div>
    <div class="row justify-content-center mb-4"> <!-- Row contenitore pulsante reset -->
        <div class="col-8 col-lg-4 col-sm-6">
            <button type="button" class="btn btn-danger" id="resetPage">RESET</button>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            $('.select2').val(null).trigger('change'); // Reset di tutte le select2 al caricamento della pagina (F5)
            // Inizializzazione di Select2
            $('.select2').select2({
                theme: "bootstrap-5",
                placeholder: function () {
                    return $(this).data('placeholder');
                },
                multiple: false
            });
			
			$('.select2').on('select2:open', function () {
				const searchField = document.querySelector('.select2-container--open .select2-search__field');
				if (searchField) {
					searchField.focus();
				}
			});
			
            // Funzione per aggiornare le opzioni disponibili nelle select
            function updateSelectOptions() {
                const allSelectedValues = new Set();
    
                // Raccogli tutti i valori selezionati
                $('.select2').each(function() {
                    const value = $(this).val();
                    if (value) {
                        allSelectedValues.add(value);
                    }
                });
    
                // Disabilita i valori già selezionati nelle altre select
                $('.select2').each(function() {
                    const currentSelect = $(this);
                    const currentValue = currentSelect.val();
    
                    currentSelect.find('option').each(function() {
                        const optionValue = $(this).attr('value');
                        if (allSelectedValues.has(optionValue) && optionValue !== currentValue) {
                            $(this).prop('disabled', true);
                        } else {
                            $(this).prop('disabled', false);
                        }
                    });
                });
            }
    
            // Aggiorna le opzioni disponibili quando una select cambia valore
            $('.select2').on('change', function() {
                updateSelectOptions();
            });
    
            // Aggiorna le opzioni all'avvio della pagina
            updateSelectOptions();
    
            // Funzioni per verificare se le scelte sono complete
            function areFirstPhasePicksSelected() {
                const alliedHero1 = $('#alliedHero1').val();
                const alliedHero2 = $('#alliedHero2').val();
                const enemyHero1 = $('#enemyHero1').val();
                const enemyHero2 = $('#enemyHero2').val();
                return alliedHero1 && alliedHero2 && enemyHero1 && enemyHero2;
            }
    
            function areSecondPhasePicksSelected() {
                const alliedHero3 = $('#alliedHero3').val();
                const alliedHero4 = $('#alliedHero4').val();
                const enemyHero3 = $('#enemyHero3').val();
                const enemyHero4 = $('#enemyHero4').val();
                return alliedHero3 && alliedHero4 && enemyHero3 && enemyHero4;
            }
    
            // Funzione per simulare la digitazione
            function simulateTyping(elementId, text, cursorId) {
                const element = document.getElementById(elementId);
                const cursor = document.getElementById(cursorId);
                element.innerHTML = ""; // Reset dell'elemento
                let index = 0;
    
                const interval = setInterval(() => {
                    if (index < text.length) {
                        if (text.charAt(index) === "<" && text.substr(index, 4) === "<br>") {
                            element.innerHTML += "<br>";
                            index += 4;
                        } else {
                            element.innerHTML += text.charAt(index);
                            index++;
                        }
                    } else {
                        clearInterval(interval);
                        cursor.style.display = "none"; // Nasconde il cursore dopo aver scritto
                    }
                }, 14);
    
                // Effetto del cursore lampeggiante
                cursor.style.visibility = "visible";
                setInterval(() => {
                    cursor.style.visibility = (cursor.style.visibility === "hidden") ? "visible" : "hidden";
                }, 500);
            }
    
            // Evento per il pulsante di suggerimento 3° e 4°
            document.getElementById("suggestButton34nr").addEventListener("click", (event) => {
                const button = event.target;
                if (!areFirstPhasePicksSelected()) {
                    $('#warningMessage34nr').remove();
                    const warningHtml = '<div id="warningMessage34nr" class="alert alert-danger" role="alert">Please select all the heroes for both teams before proceeding!</div>';
                    $(button).closest('.row').before(warningHtml);
                    return;
                }
                $('#warningMessage34nr').remove();
                button.disabled = true;
                button.classList.add("disabled");
                // Recupera i valori selezionati
                const data = {
                    alliedHero1: $('#alliedHero1').val(),
                    alliedHero2: $('#alliedHero2').val(),
                    enemyHero1: $('#enemyHero1').val(),
                    enemyHero2: $('#enemyHero2').val(),
                };
                // Invia i dati al server tramite AJAX
                $.ajax({
                    url: "/suggest34nr", // Endpoint definito in Flask
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data), // Serializza i dati in JSON
                    success: function(response) {
                        // Simula la digitazione usando il testo restituito dal server
                        simulateTyping("generatedText34nr", response.prompt, "cursor34nr");
                    },
                    error: function() {
                        alert("An error occurred while processing your request. Please try again.");
                        button.disabled = false;
                        button.classList.remove("disabled");
                    }
                });
            });
    
            // Evento per il pulsante di suggerimento 5°
            document.getElementById("suggestButton5").addEventListener("click", (event) => {
                const button = event.target;
                if (!areSecondPhasePicksSelected()) {
                    $('#warningMessage5nr').remove();
                    const warningHtml = '<div id="warningMessage5nr" class="alert alert-danger" role="alert">Please select all the heroes for both teams before proceeding!</div>';
                    $(button).closest('.row').before(warningHtml);
                    return;
                }
                $('#warningMessage5nr').remove();
                button.disabled = true;
                button.classList.add("disabled");
                // Recupera i valori selezionati
                const data = {
                    alliedHero1: $('#alliedHero1').val(),
                    alliedHero2: $('#alliedHero2').val(),
                    alliedHero3: $('#alliedHero3').val(),
                    alliedHero4: $('#alliedHero4').val(),
                    enemyHero1: $('#enemyHero1').val(),
                    enemyHero2: $('#enemyHero2').val(),
                    enemyHero3: $('#enemyHero3').val(),
                    enemyHero4: $('#enemyHero4').val(),
                };
                // Invia i dati al server tramite AJAX
                $.ajax({
                    url: "/suggest5nr", // Endpoint definito in Flask
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data), // Serializza i dati in JSON
                    success: function(response) {
                        // Simula la digitazione usando il testo restituito dal server
                        simulateTyping("generatedText5", response.prompt, "cursor5");
                    },
                    error: function() {
                        alert("An error occurred while processing your request. Please try again.");
                        button.disabled = false;
                        button.classList.remove("disabled");
                    }
                });
            });
    
            // Evento per il pulsante di reset
            document.getElementById('resetPage').addEventListener('click', function() {
                $('.select2').val(null).trigger('change'); // Reset di tutte le select2
                $('#warningMessage34nr').remove(); // Rimuovi messaggi di avviso
                $('#warningMessage5nr').remove();
                $('#generatedText34nr').html('<span id="cursor34nr" class="cursor">|</span>'); // Reset testo
                $('#generatedText5').html('<span id="cursor5" class="cursor">|</span>'); // Reset testo
                $('#suggestButton34nr').prop('disabled', false).removeClass('disabled');
                $('#suggestButton5').prop('disabled', false).removeClass('disabled');
                updateSelectOptions(); // Aggiorna le opzioni disponibili
            });
        });
    </script>            
{% endblock %}
{% set title = "AI Picker Suggestor for Normal or Ranked Mode" %}